#conda install: https://github.com/brando90/ultimate-utils/blob/master/sh_files_repo/download_and_install_conda.sh

# .bashrc
# todo, read to correct silly mistake: https://unix.stackexchange.com/questions/728040/why-is-my-ln-command-trying-to-create-a-sym-link-with-a-duplicate-name
ulimit -n 120000
# check soft limit, output 120_000
#ulimit -Sn
# check hard limit, output 120_000
#ulimit -Hn

# - use local machine as home, can't start with cd because like in .bashrc.user since we need to figure out local path in lfs
#export LOCAL_MACHINE_PWD=$(python3 -c "import socket;hostname=socket.gethostname().split('.')[0];print(f'/lfs/{hostname}/0/brando9');")
export LOCAL_MACHINE_PWD=$(python3 -c "import socket;hostname=socket.gethostname().split('.')[0];print('/lfs/'+str(hostname)+'/0/brando9');")
mkdir -p $LOCAL_MACHINE_PWD
export WANDB_DIR=$LOCAL_MACHINE_PWD
export HOME=$LOCAL_MACHINE_PWD

# - set up afs short cuts
cd $HOME
export TEMP=$HOME
export AFS=/afs/cs.stanford.edu/u/brando9
export DFS=/dfs/scratch0/brando9/
alias afs='cd $AFS'

# prompt colours
BLACK='\e[0;30m'
RED='\e[0;31m'
GREEN='\e[0;32m'
BROWN='\e[0;33m'
BLUE='\e[0;34m'
PURPLE='\e[0;35m'
CYAN='\e[0;36m'
LIGHT_GREY='\e[0;37m'
DARK_GREY='\e[1;30m'
LIGHT_RED='\e[1;31m'
LIGHT_GREEN='\e[1;32m'
YELLOW='\e[1;33m'
LIGHT_BLUE='\e[1;34m'
LIGHT_PURPLE='\e[1;35m'
LIGHT_CYAN='\e[1;36m'
WHITE='\e[1;37m'

BACK_DEFAULT_COLOR='\e[m'

HOST_PART='$(hostname | cut -d. -f1)'
export PS1="\[$LIGHT_GREY\]\u@$HOST_PART\[$LIGHT_GREEN\]\w\[$LIGHT_GREY\] \$ \[$LIGHT_CYAN\]"

# Source global definitions
if [ -f /etc/bashrc ]; then
        . /etc/bashrc
fi
if [ -f $HOME/.bashrc ]; then
        sh $HOME/.bashrc
fi

# - https://ilwiki.stanford.edu/doku.php?id=hints:gpu
#module load gcc/9.2.0
#module load cuda-toolkit/10.2
#module load cuda-toolkit/11.1
#source cuda11.1
#sh cuda11.1
#source cuda11.7
export PATH=/usr/local/cuda-11.7/bin:$PATH
export LD_LIBRARY_PATH=/usr/local/cuda-11.7/lib64:$LD_LIBRARY_PATH

# - set up rbenv, ruby-build, & ruby
export PATH="$HOME/.rbenv/bin:$PATH"
eval "$(rbenv init -)"
export PATH="$HOME/.ruby-build/bin:$PATH"
export PATH="$HOME/.local/bin:$PATH"

# - conda, todo: move to miniconda & have it be $HOME so local lfs home
export PATH="$HOME/miniconda/bin:$PATH"
source $HOME/miniconda/bin/activate
#conda activate metalearning_gpu
#conda activate iit_synthesis
#conda activate mds_env_gpu
#conda activate data_quality
conda activate maf

# legacy
# ln -s file1 link1
#ln -s /dfs/scratch0/brando9/anaconda $HOME/anaconda
#export PATH="$DFS/anaconda/bin:$PATH"
#source $DFS/anaconda/bin/activate
#conda activate metalearning_gpu
#conda activate iit_synthesis
#conda activate mds_env_gpu

export WANDB_API_KEY=xxx
export SU_PASSWORD=""

# opam configuration
# test -r /dfs/scratch0/brando9/.opam/opam-init/init.sh && . /dfs/scratch0/brando9/.opam/opam-init/init.sh > /dev/null 2> /dev/null || true
#eval $(opam env)
#opam init --disable-sandboxing
#opam update --all
#eval $(opam env)

#tr ':' '\n' <<< "$PATH"

# - link git repos to local lfs. ref: https://unix.stackexchange.com/questions/728040/why-is-my-ln-command-trying-to-create-a-sym-link-with-a-duplicate-name
# echo $HOME
# ln -s file1 link1
if [ ! -e "$HOME/ultimate-utils" ]; then
  ln -s /afs/cs.stanford.edu/u/brando9/ultimate-utils $HOME/ultimate-utils
fi

if [ ! -e "$HOME/diversity-for-predictive-success-of-meta-learning" ]; then
  ln -s /afs/cs.stanford.edu/u/brando9/diversity-for-predictive-success-of-meta-learning $HOME/diversity-for-predictive-success-of-meta-learning  
fi

if [ ! -e "$HOME/pycoq" ]; then
  ln -s /afs/cs.stanford.edu/u/brando9/pycoq $HOME/pycoq
fi

if [ ! -e "$HOME/iit-term-synthesis" ]; then
  ln -s /afs/cs.stanford.edu/u/brando9/iit-term-synthesis $HOME/iit-term-synthesis
fi

#if [ ! -e "$HOME/proverbot9001" ]; then
#  ln -s /afs/cs.stanford.edu/u/brando9/proverbot9001 $HOME/proverbot9001
#fi

if [ ! -e "$HOME/ultimate-pycoq" ]; then
  ln -s /afs/cs.stanford.edu/u/brando9/ultimate-pycoq $HOME/ultimate-pycoq  
fi

if [ ! -e "$HOME/massive-autoformalization-maf" ]; then
  ln -s /afs/cs.stanford.edu/u/brando9/massive-autoformalization-maf $HOME/massive-autoformalization-maf
fi

if [ ! -e "$HOME/.bashrc.lfs" ]; then
  ln -s /afs/cs.stanford.edu/u/brando9/.bashrc.lfs $HOME/.bashrc.lfs
fi

# bashrc.lfs to dfs, the one different one
if [ ! -e "/dfs/scratch0/brando9/.bashrc.lfs" ]; then
  ln -s /afs/cs.stanford.edu/u/brando9/.bashrc.lfs /dfs/scratch0/brando9/.bashrc.lfs
fi

if [ ! -e "$HOME/keys" ]; then
  ln -s $AFS/keys ~/keys
fi

if [ ! -e "$HOME/beyond-scale-language-data-diversity" ]; then
  ln -s $AFS/beyond-scale-language-data-diversity ~/beyond-scale-language-data-diversity
fi

if [ ! -e "$HOME/evals-for-autoformalization" ]; then
  ln -s /afs/cs.stanford.edu/u/brando9/evals-for-autoformalization $HOME/evals-for-autoformalization
fi

# - mds
mkdir -p $HOME/data/mds
export MDS_DATA_PATH=$HOME/data/mds
mkdir -p $MDS_DATA_PATH/records
mkdir -p $MDS_DATA_PATH/splits
export RECORDS=$MDS_DATA_PATH/records
export SPLITS=$MDS_DATA_PATH/splits

# -- some default gpu
#export CUDA_VISIBLE_DEVICES=5
export LEAST_GPU_ID=$(nvidia-smi --query-gpu=memory.used --format=csv,nounits,noheader | awk '{print NR-1 " " $1}' | sort -nk2 | head -n1 | cut -d' ' -f1)
export CUDA_VISIBLE_DEVICES=$LEAST_GPU_ID

# -- keys

export keys_brando=$(cat ~/keys/openai_api_brandos_personal_key.txt)
export keys_koyejolab=$(cat ~/keys/openai_api_key_brandos_koyejolab.txt)

export keys=$keys_koyejolab
